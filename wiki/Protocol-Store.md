# 协议商店

协议商店功能允许用户从 GitHub 仓库浏览和下载协议定义文件，无需手动下载和导入。

## 目录

- [概述](#概述)
- [功能特性](#功能特性)
- [使用方法](#使用方法)
- [协议文件格式](#协议文件格式)
- [技术实现](#技术实现)
- [注意事项](#注意事项)

## 概述

### GitHub 仓库

- **仓库地址**: https://github.com/chenqi92/keke-proto-tool-shop
- **协议格式**: `.kkp.yaml`, `.kpt`, `.yaml`

### 主要功能

- 📦 从 GitHub 仓库浏览可用协议
- 🔍 搜索和筛选协议
- ⬇️ 一键下载并安装协议
- 🔄 自动刷新协议列表
- 💾 缓存机制减少 API 调用

## 功能特性

### 1. 协议浏览

协议商店从 GitHub 仓库自动获取所有可用协议，并显示详细信息：

- **协议名称**: 协议的显示名称
- **版本号**: 协议的版本（SemVer 格式）
- **作者**: 协议的作者或组织
- **描述**: 协议的简要说明
- **分类**: 协议所属的类别
- **标签**: 协议的标签（用于搜索和分类）

### 2. 搜索和筛选

**搜索功能**:
- 支持按协议名称搜索
- 支持按描述内容搜索
- 支持按分类搜索
- 支持按标签搜索
- 实时过滤显示结果

**分类筛选**:
- 按协议分类筛选显示
- 点击"全部"显示所有协议
- 每个分类按钮显示该分类的协议数量

**已安装标识**:
- 自动标识已安装的协议
- 已安装的协议显示"已安装"标识
- 防止重复安装

### 3. 协议安装

**安装流程**:
1. 在协议商店中找到需要的协议
2. 点击"安装"按钮
3. 系统自动下载协议文件
4. 验证协议格式
5. 导入到本地协议仓库
6. 显示安装成功提示

**安装特性**:
- 一键下载并安装
- 自动导入到本地协议仓库
- 安装后自动刷新已安装列表
- 显示安装进度和状态
- 安装失败时显示详细错误信息

### 4. 缓存机制

为了减少 GitHub API 调用次数和提高性能：

- **缓存时间**: 协议列表缓存 5 分钟
- **自动刷新**: 缓存过期后自动刷新
- **手动刷新**: 支持手动强制刷新
- **智能更新**: 只在需要时更新缓存

## 使用方法

### 访问协议商店

1. 打开 ProtoTool 应用程序
2. 点击左侧导航栏的"协议仓库"标签
3. 在顶部选择"协议商店"标签页

### 浏览协议

协议以卡片形式展示：

```
┌─────────────────────────────┐
│ 📦 HJ212-2017              │
│                             │
│ 版本: 1.0.0                │
│ 作者: Environmental Team   │
│ 分类: environmental        │
│                             │
│ 环保数据传输协议...        │
│                             │
│ [安装] 或 [已安装]         │
└─────────────────────────────┘
```

每个卡片显示：
- 协议图标和名称
- 版本号
- 作者信息
- 分类标签
- 简要描述
- 安装按钮或已安装标识

### 搜索协议

1. 在搜索框中输入关键词
2. 支持搜索：
   - 协议名称
   - 描述内容
   - 分类名称
   - 标签
3. 实时过滤显示结果
4. 清空搜索框显示所有协议

### 筛选协议

**按分类筛选**:
1. 点击分类按钮
2. 只显示该分类的协议
3. 点击"全部"显示所有协议

**可用分类**:
- **environmental**: 环保协议（如 HJ212）
- **industrial**: 工业协议（如 Modbus）
- **iot**: 物联网协议
- **network**: 网络协议
- **custom**: 自定义协议

### 安装协议

**安装步骤**:
1. 找到需要的协议
2. 点击"安装"按钮
3. 等待下载和安装完成
4. 查看安装成功提示
5. 在"已安装协议"标签页中查看

**安装后**:
- 协议自动添加到本地仓库
- 可以在会话中使用该协议
- 可以查看协议详细信息
- 可以导出或删除协议

### 刷新协议列表

**手动刷新**:
1. 点击右上角的"刷新"按钮
2. 强制从 GitHub 重新获取最新协议列表
3. 清除缓存并更新显示

**自动刷新**:
- 缓存过期后自动刷新
- 首次打开时自动加载
- 安装协议后自动更新

## 协议文件格式

### YAML 格式 (.kkp.yaml)

```yaml
meta:
  name: "协议名称"
  version: "1.0.0"
  author: "作者名称"
  description: "协议描述"
  category: "分类"

framing:
  mode: delimiters
  header: "##"
  footer: "\r\n"

fields:
  - name: field1
    at: 0
    size: 4
    encoding: utf8
```

### KPT 格式 (.kpt)

```
protocol "protocol-id" {
  title "协议名称"
  version "1.0.0"
  description "协议描述"
  
  frame {
    mode delimiters
    header "##"
    footer "\r\n"
  }
  
  field "field1" {
    at +0
    size 4
    encoding utf8
  }
}
```

详见 [[Protocol Format Guide|Protocol-Format-Guide]]。

## 技术实现

### 前端组件

**ProtocolStore.tsx**:
- 协议列表展示
- 搜索和筛选功能
- 安装操作界面
- 状态管理

**ProtocolPluginManager.tsx**:
- 标签页切换（已安装/商店）
- 协议管理功能集成
- 统一的用户界面

### 服务层

**ProtocolStoreService.ts**:
- GitHub API 调用
- 协议元数据解析
- 缓存管理
- 搜索和筛选逻辑

**ProtocolRepositoryService.ts**:
- 协议导入
- 本地存储管理
- 协议列表查询
- 协议验证

### GitHub API 使用

```typescript
// 获取仓库内容
GET https://api.github.com/repos/chenqi92/keke-proto-tool-shop/contents

// 下载文件内容
GET https://raw.githubusercontent.com/chenqi92/keke-proto-tool-shop/main/{filename}
```

**API 限制**:
- 未认证：60 次/小时
- 已认证：5000 次/小时

## 注意事项

### 1. 网络连接

- 需要网络连接才能访问 GitHub 仓库
- 如果网络不稳定，可能导致加载失败
- 建议在网络良好的环境下使用

### 2. API 限制

- GitHub API 有速率限制
- 未认证用户：60 次/小时
- 建议配置 GitHub Token 提高限制
- 使用缓存减少 API 调用

### 3. 协议格式

- 只支持 `.kkp.yaml`, `.kpt`, `.yaml` 格式
- 协议文件必须符合格式规范
- 安装前会验证协议格式的正确性

### 4. 协议验证

- 安装前会验证协议文件
- 必须包含完整的 framing 配置
- 格式错误的协议无法安装
- 详见 [[Protocol Troubleshooting|Protocol-Troubleshooting]]

### 5. 重复安装

- 已安装的协议会显示"已安装"标识
- 无法重复安装相同的协议
- 如需更新，请先删除旧版本

## 错误处理

### 网络错误

**症状**: 无法加载协议列表

**解决方法**:
1. 检查网络连接
2. 确认可以访问 GitHub
3. 检查防火墙设置
4. 配置代理（如果需要）

### 解析错误

**症状**: 协议文件无法解析

**解决方法**:
1. 检查协议文件格式
2. 验证 YAML/KPT 语法
3. 确认包含必需字段
4. 查看详细错误信息

### 安装失败

**症状**: 协议安装失败

**解决方法**:
1. 查看错误提示
2. 检查协议文件完整性
3. 验证协议格式
4. 重试安装
5. 手动下载并导入

### API 限制

**症状**: 提示 API 限制

**解决方法**:
1. 等待限制重置（每小时重置）
2. 配置 GitHub Token
3. 使用缓存的数据
4. 减少刷新频率

## 未来改进

计划中的功能改进：

1. **协议评分**: 添加用户评分和评论功能
2. **协议更新**: 检测已安装协议的更新
3. **协议预览**: 安装前预览协议内容
4. **批量安装**: 支持批量选择和安装
5. **离线模式**: 支持离线浏览已缓存的协议
6. **协议推荐**: 基于使用情况推荐相关协议
7. **GitHub 认证**: 支持 GitHub Token 提高 API 限制
8. **协议分享**: 分享协议到社交平台

## 贡献协议

欢迎向协议商店贡献协议！

### 贡献步骤

1. Fork [协议商店仓库](https://github.com/chenqi92/keke-proto-tool-shop)
2. 添加您的协议文件
3. 确保协议文件完整且格式正确
4. 提交 Pull Request
5. 在 PR 描述中说明：
   - 协议用途
   - 测试情况
   - 参考资料

### 协议要求

- 包含完整的元数据
- 包含完整的 framing 配置
- 添加详细的描述和注释
- 提供使用示例
- 通过格式验证

详见协议商店的贡献指南。

## 相关资源

- [[Protocol System|Protocol-System]] - 协议系统概述
- [[Protocol Format Guide|Protocol-Format-Guide]] - 协议格式规范
- [[Protocol Troubleshooting|Protocol-Troubleshooting]] - 问题排查
- [协议商店仓库](https://github.com/chenqi92/keke-proto-tool-shop)

---

**上一页**: [[Protocol System|Protocol-System]] | **下一页**: [[Protocol Troubleshooting|Protocol-Troubleshooting]]

